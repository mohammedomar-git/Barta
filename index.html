<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Messenger | Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .messages-container::-webkit-scrollbar { width: 6px; }
        .messages-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        body { background-color: #f0f2f5; }
        #chat-screen { height: 100vh; max-width: 600px; margin: 0 auto; }
    </style>
</head>
<body class="antialiased">

    <div id="auth-screen" class="flex flex-col items-center justify-center min-h-screen p-4 bg-white">
        <div class="text-center">
            <div class="bg-blue-600 text-white w-20 h-20 rounded-3xl flex items-center justify-center text-4xl mx-auto mb-6 shadow-lg">
                <i class="fas fa-comments"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Welcome to Barta</h1>
            <p class="text-gray-500 mb-8">Sign in to start chatting in real-time</p>
            <button id="login-btn" class="flex items-center justify-center gap-3 bg-white border border-gray-300 px-6 py-3 rounded-full font-semibold text-gray-700 hover:bg-gray-50 transition-all shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6" alt="Google">
                Sign in with Google
            </button>
        </div>
    </div>

    <div id="chat-screen" class="hidden flex flex-col bg-white shadow-2xl overflow-hidden">
        <header class="bg-blue-600 p-4 flex items-center justify-between text-white shadow-md">
            <div class="flex items-center gap-3">
                <img id="user-photo" src="" alt="Profile" class="w-10 h-10 rounded-full border-2 border-white/50">
                <div>
                    <h2 id="user-name" class="font-bold leading-none text-sm">...</h2>
                    <span class="text-xs text-blue-100 flex items-center gap-1">
                        <span class="w-2 h-2 bg-green-400 rounded-full"></span> Online
                    </span>
                </div>
            </div>
            <button id="logout-btn" class="p-2 hover:bg-blue-700 rounded-lg transition-colors">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </header>

        <div id="messages-list" class="flex-1 overflow-y-auto p-4 space-y-4 messages-container bg-[#e5ddd5]">
            </div>

        <form id="chat-form" class="p-4 bg-white border-t flex gap-2">
            <input 
                type="text" 
                id="message-input" 
                placeholder="Type a message..." 
                class="flex-1 bg-gray-100 border-none focus:ring-2 focus:ring-blue-500 rounded-full px-4 py-2 outline-none"
                autocomplete="off"
            >
            <button 
                type="submit" 
                id="send-btn" 
                disabled 
                class="bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700 transition-colors"
            >
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            orderBy, 
            onSnapshot, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCTYtlZE2TU8QKnu1hirUu6Y6wiJWRt0fI",
            authDomain: "barta-23821.firebaseapp.com",
            databaseURL: "https://barta-23821-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "barta-23821",
            storageBucket: "barta-23821.firebasestorage.app",
            messagingSenderId: "640615948260",
            appId: "1:640615948260:web:dd6787a738c11e4ee6f1f1",
            measurementId: "G-RT04QV05F8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- 2. DOM ELEMENTS ---
        const authScreen = document.getElementById('auth-screen');
        const chatScreen = document.getElementById('chat-screen');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const messagesList = document.getElementById('messages-list');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const userNameDisp = document.getElementById('user-name');
        const userPhotoDisp = document.getElementById('user-photo');

        let currentUser = null;

        // --- 3. AUTH LOGIC ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authScreen.classList.add('hidden');
                chatScreen.classList.remove('hidden');
                userNameDisp.innerText = user.displayName;
                userPhotoDisp.src = user.photoURL || 'https://via.placeholder.com/40';
                initChat();
            } else {
                currentUser = null;
                authScreen.classList.remove('hidden');
                chatScreen.classList.add('hidden');
                messagesList.innerHTML = '';
            }
        });

        loginBtn.addEventListener('click', () => signInWithPopup(auth, provider));
        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- 4. CHAT LOGIC ---
        function initChat() {
            const q = query(collection(db, "messages"), orderBy("createdAt", "asc"));
            
            // Real-time listener
            onSnapshot(q, (snapshot) => {
                messagesList.innerHTML = '';
                snapshot.forEach((doc) => {
                    renderMessage(doc.data());
                });
                scrollToBottom();
            });
        }

        async function sendMessage(e) {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text || !currentUser) return;

            messageInput.value = '';
            sendBtn.disabled = true;

            try {
                await addDoc(collection(db, "messages"), {
                    text: text,
                    uid: currentUser.uid,
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error sending message:", error);
                alert("Failed to send message.");
            }
        }

        function renderMessage(data) {
            const isMe = data.uid === currentUser?.uid;
            const messageEl = document.createElement('div');
            messageEl.className = `flex ${isMe ? 'justify-end' : 'justify-start'} animate-in fade-in duration-300`;
            
            messageEl.innerHTML = `
                <div class="max-w-[80%] flex ${isMe ? 'flex-row-reverse' : 'flex-row'} items-end gap-2">
                    <img src="${data.photoURL}" class="w-6 h-6 rounded-full mb-1">
                    <div class="${isMe ? 'bg-blue-600 text-white rounded-l-xl rounded-tr-xl' : 'bg-white text-gray-800 rounded-r-xl rounded-tl-xl'} p-3 shadow-sm">
                        ${!isMe ? `<p class="text-[10px] font-bold opacity-70 mb-1">${data.displayName}</p>` : ''}
                        <p class="text-sm break-words">${escapeHTML(data.text)}</p>
                    </div>
                </div>
            `;
            messagesList.appendChild(messageEl);
        }

        // --- 5. UTILS & UI HELPERS ---
        messageInput.addEventListener('input', (e) => {
            sendBtn.disabled = !e.target.value.trim();
        });

        chatForm.addEventListener('submit', sendMessage);

        function scrollToBottom() {
            messagesList.scrollTop = messagesList.scrollHeight;
        }

        function escapeHTML(str) {
            const p = document.createElement('p');
            p.textContent = str;
            return p.innerHTML;
        }
    </script>
</body>
</html>

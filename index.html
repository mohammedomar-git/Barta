<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barta Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; height: 100dvh; display: flex; align-items: center; justify-content: center; margin: 0; overflow: hidden; font-family: sans-serif; }
        .phone-frame { width: 100%; max-width: 400px; height: 92vh; background: white; position: relative; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-radius: 30px; border: 6px solid #222; overflow: hidden; }
        @media (max-width: 450px) { .phone-frame { height: 100dvh; border-radius: 0; border: none; } }
        .chat-bg { background-color: #e5ddd5; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .bubble { padding: 8px 12px; margin-bottom: 5px; max-width: 80%; font-size: 14px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .b-me { background: #dcf8c6; border-radius: 12px 0 12px 12px; align-self: flex-end; }
        .b-them { background: #ffffff; border-radius: 0 12px 12px 12px; align-self: flex-start; }
    </style>
</head>
<body>

<div class="phone-frame">
    <div id="auth-screen" class="flex flex-col items-center justify-center h-full p-8 bg-white">
        <div class="w-16 h-16 bg-[#25d366] rounded-2xl flex items-center justify-center text-white text-3xl mb-4"><i class="fas fa-comments"></i></div>
        <h1 class="text-xl font-bold mb-10 text-gray-800 tracking-tight">BARTA PRO</h1>
        <button id="login-btn" class="w-full py-3.5 bg-gray-900 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-transform active:scale-95">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5"> Start with Google
        </button>
    </div>

    <div id="list-screen" class="hidden flex flex-col h-full">
        <header class="p-4 bg-[#075e54] text-white flex justify-between items-center shadow-lg">
            <h2 class="font-bold">Chat Barta</h2>
            <button id="logout-btn"><i class="fas fa-sign-out-alt"></i></button>
        </header>
        <div id="users-list" class="flex-1 overflow-y-auto divide-y divide-gray-50 hide-scrollbar"></div>
    </div>

    <div id="chat-screen" class="hidden absolute inset-0 bg-white flex flex-col">
        <header class="p-3 bg-[#075e54] text-white flex items-center gap-3">
            <button id="close-chat" class="p-1"><i class="fas fa-chevron-left"></i></button>
            <img id="target-pic" class="w-10 h-10 rounded-full border border-white/20">
            <div class="flex-1">
                <h3 id="target-name" class="font-bold text-sm truncate">...</h3>
                <p id="typing-ui" class="text-[10px] text-green-300 hidden italic">typing...</p>
            </div>
        </header>

        <div id="request-ui" class="hidden p-4 bg-yellow-50 border-b border-yellow-100 text-center">
            <p class="text-[11px] text-yellow-700 mb-2">Want to chat? Accept to start.</p>
            <div class="flex justify-center gap-2">
                <button id="accept-btn" class="px-5 py-1.5 bg-green-600 text-white rounded-full text-[10px] font-bold">Accept</button>
            </div>
        </div>

        <div id="chat-flow" class="flex-1 overflow-y-auto p-4 flex flex-col chat-bg hide-scrollbar"></div>

        <form id="chat-form" class="p-3 bg-gray-50 border-t flex items-center gap-2">
            <input type="text" id="chat-input" placeholder="Type message..." class="flex-1 py-2 px-4 rounded-full border border-gray-200 outline-none text-sm">
            <button type="submit" class="text-[#075e54] px-2 active:scale-90"><i class="fas fa-paper-plane text-xl"></i></button>
        </form>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, collection, query, orderBy, onSnapshot, addDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCTYtlZE2TU8QKnu1hirUu6Y6wiJWRt0fI",
        authDomain: "barta-23821.firebaseapp.com",
        projectId: "barta-23821",
        storageBucket: "barta-23821.firebasestorage.app",
        messagingSenderId: "640615948260",
        appId: "1:640615948260:web:dd6787a738c11e4ee6f1f1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let me = null, activeChatId = null, targetUid = null;

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            me = user;
            await setDoc(doc(db, "users", user.uid), { uid: user.uid, name: user.displayName, photo: user.photoURL }, { merge: true });
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('list-screen').classList.remove('hidden');
            loadUsers();
        } else {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('list-screen').classList.add('hidden');
        }
    });

    document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider);
    document.getElementById('logout-btn').onclick = () => signOut(auth);

    function loadUsers() {
        onSnapshot(collection(db, "users"), (snap) => {
            const list = document.getElementById('users-list');
            list.innerHTML = snap.docs.map(d => d.data()).filter(u => u.uid !== me.uid).map(u => `
                <div onclick="openChat('${u.uid}', '${u.name}', '${u.photo}')" class="flex items-center gap-3 p-4 active:bg-gray-100 cursor-pointer border-b border-gray-50">
                    <img src="${u.photo}" class="w-11 h-11 rounded-full border">
                    <div class="flex-1 min-w-0"><h4 class="font-bold text-sm text-gray-800 truncate">${u.name}</h4><p class="text-[10px] text-gray-400">Click to start conversation</p></div>
                </div>
            `).join('');
        });
    }

    window.openChat = async (tid, name, photo) => {
        targetUid = tid;
        activeChatId = me.uid < tid ? `${me.uid}_${tid}` : `${tid}_${me.uid}`;
        document.getElementById('target-name').innerText = name;
        document.getElementById('target-pic').src = photo;
        document.getElementById('chat-screen').classList.remove('hidden');
        
        const chatRef = doc(db, "chats", activeChatId);
        const chatSnap = await getDoc(chatRef);
        const data = chatSnap.exists() ? chatSnap.data() : null;

        // Message Request Logic
        if (data && data.status === 'pending' && data.requestedBy !== me.uid) {
            document.getElementById('request-ui').classList.remove('hidden');
            document.getElementById('chat-form').classList.add('hidden');
        } else {
            document.getElementById('request-ui').classList.add('hidden');
            document.getElementById('chat-form').classList.remove('hidden');
        }

        // Messages Listener (Uses the Index you created)
        const q = query(collection(db, `chats/${activeChatId}/messages`), orderBy("ts", "asc"));
        onSnapshot(q, (snap) => {
            const flow = document.getElementById('chat-flow');
            flow.innerHTML = snap.docs.map(d => {
                const m = d.data();
                return `<div class="bubble ${m.sid === me.uid ? 'b-me' : 'b-them'}">${m.txt}<div class="text-[8px] opacity-40 mt-1 text-right">${m.stamp || ''}</div></div>`;
            }).join('');
            flow.scrollTop = flow.scrollHeight;
        });

        // Typing Listener
        onSnapshot(chatRef, (doc) => {
            const d = doc.data();
            document.getElementById('typing-ui').classList.toggle('hidden', !(d && d[`typing_${targetUid}`]));
        });
    };

    document.getElementById('accept-btn').onclick = async () => {
        await updateDoc(doc(db, "chats", activeChatId), { status: 'accepted' });
        document.getElementById('request-ui').classList.add('hidden');
        document.getElementById('chat-form').classList.remove('hidden');
    };

    document.getElementById('chat-input').oninput = () => {
        setDoc(doc(db, "chats", activeChatId), { [`typing_${me.uid}`]: true }, { merge: true });
        clearTimeout(window.ty);
        window.ty = setTimeout(() => setDoc(doc(db, "chats", activeChatId), { [`typing_${me.uid}`]: false }, { merge: true }), 2000);
    };

    document.getElementById('chat-form').onsubmit = async (e) => {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        const val = input.value.trim();
        if (!val) return;
        input.value = '';

        const chatRef = doc(db, "chats", activeChatId);
        const chatSnap = await getDoc(chatRef);
        if (!chatSnap.exists()) {
            await setDoc(chatRef, { status: 'pending', requestedBy: me.uid });
        }

        await addDoc(collection(db, `chats/${activeChatId}/messages`), {
            txt: val, sid: me.uid, ts: serverTimestamp(), 
            stamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        });
    };

    document.getElementById('close-chat').onclick = () => document.getElementById('chat-screen').classList.add('hidden');
</script>
</body>
</html>
